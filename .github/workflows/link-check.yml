name: Link Check

on:
  schedule:
    - cron: "0 10 * * 1"   # Every Monday at 10:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  link-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract and check URLs
        id: check
        run: |
          python3 - <<'EOF'
          import re, subprocess, sys, json
          from pathlib import Path

          root = Path(".")
          files = [root / "README.md", root / "index.html"]

          # Skip these known-flaky or rate-limited domains
          SKIP_PATTERNS = [
              "linkedin.com",
              "fonts.googleapis.com",
              "fonts.gstatic.com",
          ]

          url_pattern = re.compile(
              r'https?://[A-Za-z0-9._~:/?#\[\]@!$&\'()*+,;%=-]+'
          )

          seen = set()
          urls = []
          for f in files:
              for m in url_pattern.finditer(f.read_text(encoding="utf-8")):
                  url = m.group(0).rstrip(")")  # strip trailing ) from markdown
                  if url in seen:
                      continue
                  if any(p in url for p in SKIP_PATTERNS):
                      continue
                  seen.add(url)
                  urls.append(url)

          failed = []
          for url in urls:
              result = subprocess.run(
                  ["curl", "-s", "-o", "/dev/null", "-w", "%{http_code}",
                   "--max-time", "15", "--location",
                   "-A", "Mozilla/5.0 (link-check)",
                   url],
                  capture_output=True, text=True
              )
              code = result.stdout.strip()
              # Accept 2xx and 3xx; treat anything else as a failure
              if not (code.startswith("2") or code.startswith("3")):
                  failed.append({"url": url, "code": code})
                  print(f"  FAIL [{code}] {url}")
              else:
                  print(f"  OK   [{code}] {url}")

          if failed:
              print(f"\nFailed: {len(failed)} URL(s)")
              with open("link-check-failures.json", "w") as fh:
                  json.dump(failed, fh, indent=2)
              sys.exit(1)
          else:
              print("\nAll links OK.")
          EOF

      - name: Open issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            let failures = [];
            try {
              failures = JSON.parse(fs.readFileSync("link-check-failures.json", "utf8"));
            } catch {}

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: ["broken-link"],
            });

            const body = [
              "The weekly link check found broken URLs in `README.md` or `index.html`.",
              "",
              "| URL | HTTP Status |",
              "|-----|------------|",
              ...failures.map(f => `| \`${f.url}\` | ${f.code} |`),
              "",
              "Fix the links and close this issue.",
            ].join("\n");

            if (issues.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body,
              });
              console.log(`Updated existing issue #${issues[0].number}`);
            } else {
              const { data } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "Broken links detected in portfolio",
                body,
                labels: ["broken-link"],
              });
              console.log(`Created issue #${data.number}`);
            }

      - name: Close resolved link issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: ["broken-link"],
            });
            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: "All links are healthy again. Closing automatically.",
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: "closed",
              });
            }
